require 'rake'

PROTO_DIR = 'lib/forest_admin_rpc_agent/proto'.freeze
OUTPUT_DIR = 'lib/forest_admin_rpc_agent/proto'.freeze

namespace :proto do
  desc 'generate ruby files from proto files'
  task :generate do
    sh "grpc_tools_ruby_protoc -I #{PROTO_DIR} " \
       "--ruby_out=#{OUTPUT_DIR} " \
       "--grpc_out=#{OUTPUT_DIR} " \
       "#{PROTO_DIR}/rpc.proto"

    # fix require in generated files
    %w[rpc_pb.rb rpc_services_pb.rb].each do |file|
      path = File.join(OUTPUT_DIR, file)
      next unless File.exist?(path)

      content = File.read(path)
      updated_content = content.gsub("require 'rpc_pb'", "require_relative 'rpc_pb'")
      updated_content.gsub!("require 'rpc_services_pb'", "require_relative 'rpc_services_pb'")

      File.write(path, updated_content)
    end
  end
end
